<?php		class Grid{	protected $con;	protected $userid;	//build the basic information about the logged in user	public function __construct($userid,$con){		$this->userid = $userid;		$this->con = $con;	}	//--- USER PROPOSALS --->	public function proposals($userid){		$sql="	SELECT 		name,							id,							userid				FROM 		proposals 				WHERE 		USERID = {$userid} 				AND 		deletedat IS NULL				ORDER BY 	CREATEDAT DESC";				$r	= mysqli_query($this->con,$sql);				$userproposals 	=  array();		while($row =  mysqli_fetch_assoc($r)){			$userproposals[] = array('name'=>urldecode($row['name']),'id'=>$row['id']);		}				return $userproposals;	}			//--- USER ZONES --->	public function zones($userid,$zoneid){				$sql		=	"select * from userzones where userid = {$userid}";		$r			=	mysqli_query($this->con,$sql);		$usrzones	=	$this->con->affected_rows;		$userzones 	= 	mysqli_fetch_assoc($r);						$sql 	= 	"select marketid as id from marketzones where zoneid = {$zoneid}";		$r 		=	mysqli_query($this->con,$sql);		$marketzone = mysqli_fetch_assoc($r);		$sql 	= 	"select * from userroles where userid = {$userid} and roleid = 15";		$r 		=	mysqli_query($this->con, $sql);		$rolecnt=	$this->con->affected_rows;		$roles	= 	mysqli_fetch_assoc($r);							   if($usrzones > 0){			$sql	=	"SELECT distinct						users.id, 						zones.id as zoneid,						zones.name AS zonename,						zones.dmaid,						zones.syscode,						zones.zipcode,						zones.timezoneid,						zones.isdma,						zones.corporationid AS zonecorporationid,						timezones.name AS timezonename,						timezones.databasename,						lcase(timezones.abbreviation) as abbreviation,						timezones.phpname,						timezones.utcdifference						FROM 			users 						INNER JOIN 	userzones 	ON users.id = userzones.userid						INNER JOIN	zones 		ON userzones.zoneid  = zones.id						INNER JOIN 	timezones 	ON zones.timezoneid = timezones.id 						WHERE ( users.id = {$userid} ) 						AND 	( users.deletedat IS NULL )  						AND 	( zones.isdma = 'no' )    						ORDER BY zones.name ASC";					}					elseif($rolecnt == 0){ //--- STANDARD USER ACCOUNT 			$sql	= 	"SELECT DISTINCT	users.id, 												zones.id as zoneid,												zones.name AS zonename,												zones.dmaid,												zones.syscode,												zones.zipcode,												zones.timezoneid,												zones.isdma,												zones.corporationid AS zonecorporationid,												timezones.name AS timezonename,												timezones.databasename,												lcase(timezones.abbreviation) as abbreviation,												timezones.phpname,												timezones.utcdifference						FROM 				users 						LEFT OUTER JOIN 	useroffices 						ON 					users.id = useroffices.userid 						INNER JOIN 			offices 						ON 					useroffices.officeid = offices.id AND offices.deletedat IS NULL						INNER JOIN 			regions 						ON 					offices.regionid = regions.id AND regions.deletedat IS NULL						INNER JOIN 			marketzones						ON 					regions.id = marketzones.marketid						INNER JOIN 			zones						ON 					marketzones.zoneid = zones.id AND zones.deletedat IS NULL						INNER JOIN 			timezones						ON 					zones.timezoneid = timezones.id						WHERE 				( users.id = {$userid} ) 						AND 					( users.deletedat IS NULL )";						if($marketzone["id"] == 14 || $marketzone["id"] == 190){						$sql = $sql."AND 	( regions.id = ".$marketzone["id"].") ";						}						$sql = $sql."AND 	( regions.deletedat IS NULL )																		AND					( zones.isdma = 'no' ) 						AND 				( zones.deletedat IS NULL )						ORDER BY 			zones.name ASC";						}		else{//--- REP FIRM ACCOUNT --->			$sql	= 	"SELECT distinct 										zones.id as zoneid,									zones.name AS zonename,									zones.dmaid,									zones.syscode,									zones.zipcode,zones.timezoneid,									zones.isdma,									zones.corporationid AS zonecorporationid,									timezones.name AS timezonename,									timezones.databasename,									lcase(timezones.abbreviation) as abbreviation,									timezones.phpname,									timezones.utcdifference												FROM 						users 		INNER JOIN corporations						ON 			corporations.id = users.corporationid												INNER JOIN 	regions 							ON 			corporations.id = regions.corporationid												INNER JOIN	marketzones 							ON 			regions.id = marketzones.marketid												INNER JOIN  zones							ON 			marketzones.zoneid = zones.id AND zones.deletedat IS NULL 												INNER JOIN 	timezones 						ON 			zones.timezoneid = timezones.id 		     												WHERE 		users.id = {$userid}												AND 		users.deletedat IS NULL												AND 		zones.isdma = 'no'						ORDER BY 	zones.name ASC";		}			$r 		= mysqli_query($this->con,$sql);		$result = array();				while($row = mysqli_fetch_assoc($r)){			$result[] = $row;		}			return $result;		}	public function dmas($userid,$zoneid){				$sql		=	"select * from userzones where userid = {$userid}";		$r			=	mysqli_query($this->con,$sql);		$usrzones	=	$this->con->affected_rows;		$userzones 	= 	mysqli_fetch_assoc($r);						$sql 	= 	"select marketid as id from marketzones where zoneid = {$zoneid}";		$r 		=	mysqli_query($this->con,$sql);		$marketzone = mysqli_fetch_assoc($r);		$sql 	= 	"select * from userroles where userid = {$userid} and roleid = 15";		$r 		=	mysqli_query($this->con, $sql);		$rolecnt=	$this->con->affected_rows;		$roles	= 	mysqli_fetch_assoc($r);							   if($usrzones > 0){			$sql	=	"SELECT distinct						users.id, 						zones.id as zoneid,						zones.name AS zonename,						zones.dmaid,						zones.syscode,						zones.zipcode,						zones.timezoneid,						zones.isdma,						zones.corporationid AS zonecorporationid,						timezones.name AS timezonename,						timezones.databasename,						lcase(timezones.abbreviation) as abbreviation,						timezones.phpname,						timezones.utcdifference						FROM 			users 						INNER JOIN 	userzones 	ON users.id = userzones.userid						INNER JOIN	zones 		ON userzones.zoneid  = zones.id						INNER JOIN 	timezones 	ON zones.timezoneid = timezones.id 						WHERE ( users.id = {$userid} ) 						AND 	( users.deletedat IS NULL )  						AND 	( zones.isdma = 'yes' )    						ORDER BY zones.name ASC";					}					elseif($rolecnt == 0){ //--- STANDARD USER ACCOUNT 			$sql	= 	"SELECT DISTINCT	users.id, 												zones.id as zoneid,												zones.name AS zonename,												zones.dmaid,												zones.syscode,												zones.zipcode,												zones.timezoneid,												zones.isdma,												zones.corporationid AS zonecorporationid,												timezones.name AS timezonename,												timezones.databasename,												lcase(timezones.abbreviation) as abbreviation,												timezones.phpname,												timezones.utcdifference						FROM 				users 						LEFT OUTER JOIN 	useroffices 						ON 					users.id = useroffices.userid 						INNER JOIN 			offices 						ON 					useroffices.officeid = offices.id AND offices.deletedat IS NULL						INNER JOIN 			regions 						ON 					offices.regionid = regions.id AND regions.deletedat IS NULL						INNER JOIN 			marketzones						ON 					regions.id = marketzones.marketid						INNER JOIN 			zones						ON 					marketzones.zoneid = zones.id AND zones.deletedat IS NULL						INNER JOIN 			timezones						ON 					zones.timezoneid = timezones.id						WHERE 				( users.id = {$userid} ) 						AND 					( users.deletedat IS NULL )";						if($marketzone["id"] == 14 || $marketzone["id"] == 190){						$sql = $sql."AND 	( regions.id = ".$marketzone["id"].") ";						}						$sql = $sql."AND 	( regions.deletedat IS NULL )																		AND					( zones.isdma = 'yes' ) 						AND 				( zones.deletedat IS NULL )						ORDER BY 			zones.name ASC";						}		else{//--- REP FIRM ACCOUNT --->			$sql	= 	"SELECT distinct 										zones.id as zoneid,									zones.name AS zonename,									zones.dmaid,									zones.syscode,									zones.zipcode,zones.timezoneid,									zones.isdma,									zones.corporationid AS zonecorporationid,									timezones.name AS timezonename,									timezones.databasename,									lcase(timezones.abbreviation) as abbreviation,									timezones.phpname,									timezones.utcdifference												FROM 						users 		INNER JOIN corporations						ON 			corporations.id = users.corporationid												INNER JOIN 	regions 							ON 			corporations.id = regions.corporationid												INNER JOIN	marketzones 							ON 			regions.id = marketzones.marketid												INNER JOIN  zones							ON 			marketzones.zoneid = zones.id AND zones.deletedat IS NULL 												INNER JOIN 	timezones 						ON 			zones.timezoneid = timezones.id 		     												WHERE 		users.id = {$userid}												AND 		users.deletedat IS NULL												AND 		zones.isdma = 'yes'						ORDER BY 	zones.name ASC";		}			$r 		= mysqli_query($this->con,$sql);		$result = array();				while($row = mysqli_fetch_assoc($r)){			$result[] = $row;		}			return $result;		}		//--- ZONE STATIONS --->	public function stations($zoneid){		$sql	=	" SELECT 	zonenetworks.zoneid,							zonenetworks.networkid,							zones.id,							zones.name,							zones.dmaid,							zones.syscode,							zones.zipcode,							zones.timezoneid,							tms_networks.networkid AS tms_networknetworkid,							tms_networks.timezone,							tms_networks.name AS tms_networkname,							tms_networks.callsign,							tms_networks.affiliate,							tms_networks.city,							tms_networks.state,							tms_networks.country,							tms_networks.dma,							tms_networks.dmanumber,							networklogos.networkid AS networklogonetworkid,							networklogos.logoid,							logos.name AS Logoname,logos.filename 				FROM 		zonenetworks 				INNER JOIN zones 				ON 		zonenetworks.zoneid = zones.id AND zones.deletedat IS NULL 				LEFT OUTER JOIN tms_networks 				ON 		zonenetworks.networkid = tms_networks.networkid 				LEFT OUTER JOIN networklogos 				ON 		tms_networks.networkid = networklogos.networkid AND networklogos.deletedat IS NULL 				LEFT OUTER JOIN logos 				ON 		networklogos.logoid = logos.id AND logos.deletedat IS NULL 				WHERE 	zonenetworks.zoneid = {$zoneid}				ORDER BY tms_networks.callsign ASC";						$r = mysqli_query($this->con, $sql);		$stations = array();		while($row = mysqli_fetch_assoc($r)){			$stations[] = $row;		}		return $stations;	}		//--- ZONE STATIONS --->	public function stationInfo($id){		$sql	=	" SELECT 	zonenetworks.zoneid,							zonenetworks.networkid,							zones.id,							zones.name,							zones.dmaid,							zones.syscode,							zones.zipcode,							zones.timezoneid,							tms_networks.networkid AS tms_networknetworkid,							tms_networks.timezone,							tms_networks.name AS tms_networkname,							tms_networks.callsign,							tms_networks.affiliate,							tms_networks.city,							tms_networks.state,							tms_networks.country,							tms_networks.dma,							tms_networks.dmanumber,							networklogos.networkid AS networklogonetworkid,							networklogos.logoid,							logos.name AS Logoname,							logos.filename 				FROM 		zonenetworks 				INNER JOIN zones 				ON 		zonenetworks.zoneid = zones.id AND zones.deletedat IS NULL 				LEFT OUTER JOIN tms_networks 				ON 		zonenetworks.networkid = tms_networks.networkid 				LEFT OUTER JOIN networklogos 				ON 		tms_networks.networkid = networklogos.networkid AND networklogos.deletedat IS NULL 				LEFT OUTER JOIN logos 				ON 		networklogos.logoid = logos.id AND logos.deletedat IS NULL 				WHERE 	tms_networks.networkid = {$id}";						$r = mysqli_query($this->con, $sql);		$stations = array();		while($row = mysqli_fetch_assoc($r)){			$stations[] = $row;		}		return $stations;	}					public function findNetwork($networkid, $networks){		foreach ($networks as $key => $value) {			if($value['networkid'] == $networkid) {				return 1;				break;			}		}		return 0;					}			public function getAbbreviation($zoneid){		$abbreviation = 'pst';				$sql	=	"SELECT 	lcase(TimeZone.abbreviation) as abbreviation					FROM 		Zone 					INNER JOIN 	TimeZone					ON			Zone.timezoneid =  TimeZone.id					WHERE 		Zone.id = ". $zoneid;						$r 			= mysqli_query($this->con, $sql);				while($row = mysqli_fetch_assoc($r)){			$abbreviation = $row['abbreviation'];		}		return $abbreviation;	}				public function hoursRange( $lower = 0, $upper = 86400, $step = 1800, $format = '' ) {	    $times = array();		    if ( empty( $format ) ) {	        $format = 'g:i A';	    }		    foreach ( range( $lower, $upper, $step ) as $increment ) {	        $increment = gmdate( 'G:i', $increment );		        list( $hour, $minutes ) = explode( ':', $increment );		        $date = new DateTime( $hour . ':' . $minutes );		        $times[(string) $increment] = $date->format( $format );	        	    }	    	    $times['23:59'] = '11:59 PM';		    return $times;	}				//THIS IS TO MAPP OLD EXP SYSTEM	public function timezonemapping($zoneabbreviation){		$tzlist="hast|-10|1|1,ast|-9|2|3,pst|-8|4|5,mdt|-7|6|8,mst|-7|14|14,cst|-6|9|10,est|-5|11|12,pr|-4|13|13";		$time_zones = explode(",",$tzlist);		$tzmapped = array();				foreach($time_zones as $value){			 $zn_ids = explode("|",$value);			 if($zn_ids[0] == $zoneabbreviation){				$tzmapped = $zn_ids;				break;			 }			 		 		} 			$dst = date('I', strtotime(date('Y-m-d')));		if($dst == 0 || $tzmapped[2] == 1 || $tzmapped[2] == 13 || $tzmapped[2] == 14)			return $tzmapped[2];		else			return $tzmapped[3];	}		}?>